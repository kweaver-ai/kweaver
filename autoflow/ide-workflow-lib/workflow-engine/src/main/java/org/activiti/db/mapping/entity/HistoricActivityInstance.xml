<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.activiti.engine.impl.persistence.entity.HistoricActivityInstanceEntity">

  <!-- HISTORIC ACTIVITY INSTANCE INSERT -->

  <insert id="insertHistoricActivityInstance" parameterType="org.activiti.engine.impl.persistence.entity.HistoricActivityInstanceEntity">
      insert into ${prefix}t_wf_hi_actinst (
        id_,
        proc_def_id_,
        proc_inst_id_,
        execution_id_,
        act_id_,
        task_id_,
        call_proc_inst_id_,
        act_name_,
        act_type_,
        assignee_,
        start_time_,
        end_time_,
        duration_,
        tenant_id_,
        proc_title,
        pre_act_id,
        pre_act_name,
        pre_act_inst_id
      ) values (
        #{id ,jdbcType=VARCHAR},
        #{processDefinitionId, jdbcType=VARCHAR},
        #{processInstanceId, jdbcType=VARCHAR},
        #{executionId, jdbcType=VARCHAR},
        #{activityId ,jdbcType=VARCHAR},
        #{taskId ,jdbcType=VARCHAR},
        #{calledProcessInstanceId ,jdbcType=VARCHAR},
        #{activityName ,jdbcType=VARCHAR},
        #{activityType ,jdbcType=VARCHAR},
        #{assignee ,jdbcType=VARCHAR},
        #{startTime, jdbcType=TIMESTAMP},
        #{endTime, jdbcType=TIMESTAMP},
        #{durationInMillis ,jdbcType=BIGINT},
        #{tenantId, jdbcType=VARCHAR},
        #{procTitle ,jdbcType=VARCHAR},
        #{preActId ,jdbcType=VARCHAR},
        #{preActName ,jdbcType=VARCHAR},
        #{preActInstId ,jdbcType=VARCHAR}
      )
  </insert>

  <insert id="bulkInsertHistoricActivityInstance" parameterType="java.util.List">
      insert into ${prefix}t_wf_hi_actinst (
        id_,
        proc_def_id_,
        proc_inst_id_,
        execution_id_,
        act_id_,
        task_id_,
        call_proc_inst_id_,
        act_name_,
        act_type_,
        assignee_,
        start_time_,
        end_time_,
        duration_,
        tenant_id_,
        proc_title,
        pre_act_id,
        pre_act_name,
        pre_act_inst_id
      ) values
      <foreach collection="list" item="historicActivityInstance" index="index" separator=",">
         (#{historicActivityInstance.id ,jdbcType=VARCHAR},
          #{historicActivityInstance.processDefinitionId, jdbcType=VARCHAR},
          #{historicActivityInstance.processInstanceId, jdbcType=VARCHAR},
          #{historicActivityInstance.executionId, jdbcType=VARCHAR},
          #{historicActivityInstance.activityId ,jdbcType=VARCHAR},
          #{historicActivityInstance.taskId ,jdbcType=VARCHAR},
          #{historicActivityInstance.calledProcessInstanceId ,jdbcType=VARCHAR},
          #{historicActivityInstance.activityName ,jdbcType=VARCHAR},
          #{historicActivityInstance.activityType ,jdbcType=VARCHAR},
          #{historicActivityInstance.assignee ,jdbcType=VARCHAR},
          #{historicActivityInstance.startTime, jdbcType=TIMESTAMP},
          #{historicActivityInstance.endTime, jdbcType=TIMESTAMP},
          #{historicActivityInstance.durationInMillis ,jdbcType=BIGINT},
          #{historicActivityInstance.tenantId, jdbcType=VARCHAR},
       	  #{historicActivityInstance.procTitle ,jdbcType=VARCHAR},
          #{historicActivityInstance.preActId ,jdbcType=VARCHAR},
          #{historicActivityInstance.preActName ,jdbcType=VARCHAR},
          #{historicActivityInstance.preActInstId ,jdbcType=VARCHAR}
          )
      </foreach>
  </insert>

  <insert id="bulkInsertHistoricActivityInstance_oracle" parameterType="java.util.List">
      INSERT ALL
      <foreach collection="list" item="historicActivityInstance" index="index">
        INTO ${prefix}t_wf_hi_actinst (
          id_,
          proc_def_id_,
          proc_inst_id_,
          execution_id_,
          act_id_,
          task_id_,
          call_proc_inst_id_,
          act_name_,
          act_type_,
          assignee_,
          start_time_,
          end_time_,
          duration_,
          tenant_id_,
          proc_title,
          pre_act_id,
          pre_act_name,
          pre_act_inst_id
        ) VALUES
           (#{historicActivityInstance.id ,jdbcType=VARCHAR},
            #{historicActivityInstance.processDefinitionId, jdbcType=VARCHAR},
            #{historicActivityInstance.processInstanceId, jdbcType=VARCHAR},
            #{historicActivityInstance.executionId, jdbcType=VARCHAR},
            #{historicActivityInstance.activityId ,jdbcType=VARCHAR},
            #{historicActivityInstance.taskId ,jdbcType=VARCHAR},
            #{historicActivityInstance.calledProcessInstanceId ,jdbcType=VARCHAR},
            #{historicActivityInstance.activityName ,jdbcType=VARCHAR},
            #{historicActivityInstance.activityType ,jdbcType=VARCHAR},
            #{historicActivityInstance.assignee ,jdbcType=VARCHAR},
            #{historicActivityInstance.startTime, jdbcType=TIMESTAMP},
            #{historicActivityInstance.endTime, jdbcType=TIMESTAMP},
            #{historicActivityInstance.durationInMillis ,jdbcType=BIGINT},
            #{historicActivityInstance.tenantId, jdbcType=VARCHAR},
            #{historicActivityInstance.procTitle ,jdbcType=VARCHAR},
            #{historicActivityInstance.preActId ,jdbcType=VARCHAR},
            #{historicActivityInstance.preActName ,jdbcType=VARCHAR},
            #{historicActivityInstance.preActInstId ,jdbcType=VARCHAR}
            )
      </foreach>
    SELECT * FROM dual
  </insert>

  <!-- HISTORIC ACTIVITY INSTANCE UPDATE -->

  <update id="updateHistoricActivityInstance" parameterType="org.activiti.engine.impl.persistence.entity.HistoricActivityInstanceEntity">
    update ${prefix}t_wf_hi_actinst set
      execution_id_ = #{executionId, jdbcType=VARCHAR},
      assignee_ = #{assignee, jdbcType=VARCHAR},
      end_time_ = #{endTime, jdbcType=TIMESTAMP},
      duration_ = #{durationInMillis ,jdbcType=BIGINT}
    where id_ = #{id}
  </update>

  <!-- HISTORIC ACTIVITY INSTANCE DELETE -->

  <delete id="deleteHistoricActivityInstancesByProcessInstanceId">
    delete from ${prefix}t_wf_hi_actinst where proc_inst_id_ = #{processInstanceId}
  </delete>

  <!-- HISTORIC ACTIVITY INSTANCE RESULT MAP -->

  <resultMap id="historicActivityInstanceResultMap" type="org.activiti.engine.impl.persistence.entity.HistoricActivityInstanceEntity">
    <id property="id" column="ID_" jdbcType="VARCHAR" />
    <result property="processDefinitionId" column="proc_def_id_" jdbcType="VARCHAR" />
    <result property="processInstanceId" column="proc_inst_id_" jdbcType="VARCHAR" />
    <result property="executionId" column="execution_id_" jdbcType="VARCHAR" />
    <result property="activityId" column="act_id_" jdbcType="VARCHAR" />
    <result property="taskId" column="task_id_" jdbcType="VARCHAR" />
    <result property="calledProcessInstanceId" column="call_proc_inst_id_" jdbcType="VARCHAR" />
    <result property="activityName" column="act_name_" jdbcType="VARCHAR" />
    <result property="activityType" column="act_type_" jdbcType="VARCHAR" />
    <result property="assignee" column="assignee_" jdbcType="VARCHAR" />
    <result property="startTime" column="start_time_" jdbcType="TIMESTAMP" />
    <result property="endTime" column="end_time_" jdbcType="TIMESTAMP" />
    <result property="durationInMillis" column="duration_" jdbcType="BIGINT" />
    <result property="tenantId" column="tenant_id_" jdbcType="VARCHAR" />
        <!--extend table columns by lw start -->
    <result property="procTitle" column="proc_title" jdbcType="VARCHAR" />
    <result property="preActId" column="pre_act_id" jdbcType="VARCHAR" />
    <result property="preActName" column="pre_act_name" jdbcType="VARCHAR" />
    <result property="preActInstId" column="pre_act_inst_id" jdbcType="VARCHAR" />
    <!--extend table columns by lw end -->
  </resultMap>

  <!-- HISTORIC ACTIVITY INSTANCE SELECT -->

  <select id="selectHistoricActivityInstance" resultMap="historicActivityInstanceResultMap">
    select * from ${prefix}t_wf_hi_actinst where act_id_ = #{activityId} and proc_inst_id_ = #{processInstanceId}
  </select>

  <select id="selectHistoricActivityInstancesByQueryCriteria" parameterType="org.activiti.engine.impl.HistoricActivityInstanceQueryImpl" resultMap="historicActivityInstanceResultMap">
    ${limitBefore}
    select RES.* ${limitBetween}
    <include refid="selectHistoricActivityInstancesByQueryCriteriaSql"/>
    ${orderBy}
    ${limitAfter}
  </select>

  <select id="selectHistoricActivityInstanceCountByQueryCriteria" parameterType="org.activiti.engine.impl.HistoricActivityInstanceQueryImpl" resultType="long">
    select count(RES.id_)
    <include refid="selectHistoricActivityInstancesByQueryCriteriaSql"/>
  </select>

  <sql id="selectHistoricActivityInstancesByQueryCriteriaSql">
    from ${prefix}t_wf_hi_actinst RES
    <where>
      <if test="processInstanceId != null">
        RES.proc_inst_id_ = #{processInstanceId}
      </if>
      <if test="activityInstanceId != null">
        and RES.id_ = #{activityInstanceId}
      </if>
      <if test="executionId != null">
        and RES.execution_id_ = #{executionId}
      </if>
      <if test="processDefinitionId != null">
        and RES.proc_def_id_ = #{processDefinitionId}
      </if>
      <if test="activityId != null">
        and RES.act_id_ = #{activityId}
      </if>
      <if test="activityName != null">
        and RES.act_name_ = #{activityName}
      </if>
      <if test="activityType != null">
        and RES.act_type_ = #{activityType}
      </if>
      <if test="assignee != null">
        and RES.assignee_ = #{assignee}
      </if>
      <if test="tenantId != null">
        and RES.tenant_id_ = #{tenantId}
      </if>
      <if test="tenantIdLike != null">
        and RES.tenant_id_ like #{tenantIdLike}${wildcardEscapeClause}
      </if>
      <if test="withoutTenantId">
        and (RES.tenant_id_ = '' or RES.tenant_id_ is null)
      </if>
      <if test="unfinished">
        and RES.end_time_ is null
      </if>
      <if test="finished">
       and RES.end_time_ is not null
      </if>
    </where>
  </sql>

  <select id="selectHistoricActivityInstanceByNativeQuery" parameterType="java.util.Map" resultMap="historicActivityInstanceResultMap">
  	<if test="resultType == 'LIST_PAGE'">
    	${limitBefore}
    </if>
    ${sql}
    <if test="resultType == 'LIST_PAGE'">
    	${limitAfter}
    </if>
  </select>

  <select id="selectHistoricActivityInstanceByNativeQuery_mssql_or_db2" parameterType="java.util.Map" resultMap="historicActivityInstanceResultMap">
  	<if test="resultType == 'LIST_PAGE'">
        ${limitBeforeNativeQuery}
  	</if>
  	${sql}
    <if test="resultType == 'LIST_PAGE'">
  		${limitAfter}
  	</if>
  </select>

  <select id="selectHistoricActivityInstanceCountByNativeQuery" parameterType="java.util.Map" resultType="long">
    ${sql}
  </select>
</mapper>
