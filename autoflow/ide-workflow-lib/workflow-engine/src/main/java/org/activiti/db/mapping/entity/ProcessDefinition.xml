<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
<mapper namespace="org.activiti.engine.impl.persistence.entity.ProcessDefinitionEntity">
  
  <!-- PROCESSDEFINITION INSERT -->

  <insert id="insertProcessDefinition" parameterType="org.activiti.engine.impl.persistence.entity.ProcessDefinitionEntity">
    insert into ${prefix}t_wf_re_procdef(id_, rev_, category_, name_, key_, version_, deployment_id_, resource_name_, dgrm_resource_name_, description_, has_start_form_key_, has_graphical_notation_ , suspension_state_, tenant_id_)
    values (#{id, jdbcType=VARCHAR},
    		1,
            #{category, jdbcType=VARCHAR},
            #{name, jdbcType=VARCHAR},
            #{key, jdbcType=VARCHAR}, 
            #{version, jdbcType=INTEGER},
            #{deploymentId, jdbcType=VARCHAR},
            #{resourceName, jdbcType=VARCHAR},
            #{diagramResourceName, jdbcType=VARCHAR},
            #{description, jdbcType=VARCHAR},
            #{hasStartFormKey, jdbcType=BOOLEAN},
            #{isGraphicalNotationDefined, jdbcType=BOOLEAN},
            #{suspensionState, jdbcType=INTEGER},
            #{tenantId, jdbcType=VARCHAR})
  </insert>

  <insert id="bulkInsertProcessDefinition" parameterType="java.util.List">
    INSERT INTO ${prefix}t_wf_re_procdef(id_, rev_, category_, name_, key_, version_, deployment_id_, resource_name_, dgrm_resource_name_, description_, has_start_form_key_, has_graphical_notation_ , suspension_state_, tenant_id_)
    VALUES 
      <foreach collection="list" item="processDefinition" index="index" separator=","> 
        (#{processDefinition.id, jdbcType=VARCHAR},
         1,
         #{processDefinition.category, jdbcType=VARCHAR},
         #{processDefinition.name, jdbcType=VARCHAR},
         #{processDefinition.key, jdbcType=VARCHAR}, 
         #{processDefinition.version, jdbcType=INTEGER},
         #{processDefinition.deploymentId, jdbcType=VARCHAR},
         #{processDefinition.resourceName, jdbcType=VARCHAR},
         #{processDefinition.diagramResourceName, jdbcType=VARCHAR},
         #{processDefinition.description, jdbcType=VARCHAR},
         #{processDefinition.hasStartFormKey, jdbcType=BOOLEAN},
         #{processDefinition.isGraphicalNotationDefined, jdbcType=BOOLEAN},
         #{processDefinition.suspensionState, jdbcType=INTEGER},
         #{processDefinition.tenantId, jdbcType=VARCHAR})
    </foreach>
  </insert>

  <insert id="bulkInsertProcessDefinition_oracle" parameterType="java.util.List">
    INSERT ALL 
    <foreach collection="list" item="processDefinition" index="index"> 
      INTO ${prefix}t_wf_re_procdef(id_, rev_, category_, name_, key_, version_, deployment_id_, resource_name_,
      dgrm_resource_name_, description_, has_start_form_key_, has_graphical_notation_ , suspension_state_, tenant_id_) VALUES
        (#{processDefinition.id, jdbcType=VARCHAR},
         1,
         #{processDefinition.category, jdbcType=VARCHAR},
         #{processDefinition.name, jdbcType=VARCHAR},
         #{processDefinition.key, jdbcType=VARCHAR}, 
         #{processDefinition.version, jdbcType=INTEGER},
         #{processDefinition.deploymentId, jdbcType=VARCHAR},
         #{processDefinition.resourceName, jdbcType=VARCHAR},
         #{processDefinition.diagramResourceName, jdbcType=VARCHAR},
         #{processDefinition.description, jdbcType=VARCHAR},
         #{processDefinition.hasStartFormKey, jdbcType=BOOLEAN},
         #{processDefinition.isGraphicalNotationDefined, jdbcType=BOOLEAN},
         #{processDefinition.suspensionState, jdbcType=INTEGER},
         #{processDefinition.tenantId, jdbcType=VARCHAR})
    </foreach>
    SELECT * FROM dual
  </insert>
  
  <!-- PROCESSDEFINITION UPDATE -->

  <update id="updateProcessDefinition" parameterType="org.activiti.engine.impl.persistence.entity.ProcessDefinitionEntity">
    update ${prefix}t_wf_re_procdef set
      rev_ = #{revisionNext, jdbcType=INTEGER},
      suspension_state_ = #{suspensionState, jdbcType=INTEGER},
      name_ = #{name, jdbcType=VARCHAR},
      category_ = #{category, jdbcType=VARCHAR}
    where id_ = #{id, jdbcType=VARCHAR}
      and rev_ = #{revision, jdbcType=INTEGER}
  </update>
  
  <update id="updateProcessDefinitionTenantIdForDeploymentId" parameterType="java.util.Map">
    update ${prefix}t_wf_re_procdef set
      tenant_id_ = #{tenantId, jdbcType=VARCHAR}
    where
      deployment_id_ = #{deploymentId, jdbcType=VARCHAR}
  </update>

  <!-- PROCESSDEFINITION DELETE -->

  <delete id="deleteProcessDefinitionsByDeploymentId" parameterType="string">
    delete from ${prefix}t_wf_re_procdef where deployment_id_ = #{deploymenId}
  </delete>
  
  <!-- PROCESSDEFINITION RESULTMAP -->

  <resultMap id="processDefinitionResultMap" type="org.activiti.engine.impl.persistence.entity.ProcessDefinitionEntity">
    <id property="id" column="id_" jdbcType="VARCHAR" />
    <result property="revision" column="rev_" />
    <result property="category" column="category_" />
    <result property="name" column="name_" />
    <result property="key" column="key_" jdbcType="VARCHAR" />
    <result property="version" column="version_" jdbcType="INTEGER"/>
    <result property="deploymentId" column="deployment_id_" jdbcType="VARCHAR"/>
    <result property="resourceName" column="resource_name_" jdbcType="VARCHAR"/>
    <result property="tenantId" column="tenant_id_" jdbcType="VARCHAR" />
    <result property="diagramResourceName" column="dgrm_resource_name_" jdbcType="VARCHAR"/>
    <result property="description" column="description_" jdbcType="VARCHAR" />
    <result property="hasStartFormKey" column="has_start_form_key_" jdbcType="BOOLEAN"/>
    <result property="isGraphicalNotationDefined" column="has_graphical_notation_" jdbcType="BOOLEAN" />
    <result property="suspensionState" column="suspension_state_" jdbcType="INTEGER"/>
  </resultMap>

  <!-- PROCESSDEFINITION SELECT -->

  <select id="selectProcessDefinition" parameterType="string" resultMap="processDefinitionResultMap">
    select * from ${prefix}t_wf_re_procdef where id_ = #{processDefinitionId}
  </select>

  <select id="selectProcessDefinitionById" parameterType="string" resultMap="processDefinitionResultMap">
    select * from ${prefix}t_wf_re_procdef where id_ = #{processDefinitionId}
  </select>

  <select id="selectProcessDefinitionsByQueryCriteria" parameterType="org.activiti.engine.impl.ProcessDefinitionQueryImpl" resultMap="processDefinitionResultMap">
  	${limitBefore}
    select RES.* ${limitBetween}
    <include refid="selectProcessDefinitionsByQueryCriteriaSql"/>
    ${orderBy}
    ${limitAfter}
  </select>

  <select id="selectProcessDefinitionCountByQueryCriteria" parameterType="org.activiti.engine.impl.ProcessDefinitionQueryImpl" resultType="long">
    select count(RES.id_)
    <include refid="selectProcessDefinitionsByQueryCriteriaSql"/>
  </select>
  
  <sql id="selectProcessDefinitionsByQueryCriteriaSql">  
    from ${prefix}t_wf_re_procdef RES
    <if test="eventSubscriptionType != null">
    	inner join ${prefix}t_wf_ru_event_subscr evt on RES.id_ = evt.configuration_
    </if>
    <where>
      <if test="id != null">
        RES.id_ = #{id}
      </if>
      <if test="ids != null and ids">
        and RES.id_ in
        <foreach item="item" index="index" collection="ids" open="(" separator="," close=")">
          #{item}
        </foreach>
      </if>
      <if test="category != null">
        and RES.category_ = #{category}
      </if>
      <if test="categoryLike != null">
        and RES.category_ like #{categoryLike}${wildcardEscapeClause}
      </if>
      <if test="categoryNotEquals != null">
        and ( RES.category_ &lt;&gt; #{categoryNotEquals} OR RES.category_ is null )
      </if>
      <if test="name != null">
        and RES.name_ = #{name}
      </if>
      <if test="nameLike != null">
        and RES.name_ like #{nameLike}${wildcardEscapeClause}
      </if>
      <if test="key != null">
        and RES.key_ = #{key}
      </if>
      <if test="keyLike != null">
        and RES.key_ like #{keyLike}${wildcardEscapeClause}
      </if>
      <if test="resourceName != null">
        and RES.resource_name_ = #{resourceName}
      </if>
      <if test="resourceNameLike != null">
        and RES.resource_name_ like #{resourceNameLike}${wildcardEscapeClause}
      </if>
      <if test="version != null">
        and RES.version_ = #{version}
      </if>
      <if test="versionGt != null">
        and RES.version_ &gt; #{versionGt}
      </if>
      <if test="versionGte != null">
        and RES.version_ &gt;= #{versionGte}
      </if>
      <if test="versionLt != null">
        and RES.version_ &lt; #{versionLt}
      </if>
      <if test="versionLte != null">
        and RES.version_ &lt;= #{versionLte}
      </if>
      <if test="deploymentId != null">
        and RES.deployment_id_ = #{deploymentId}
      </if>
      <if test="deploymentIds != null and !deploymentIds.isEmpty()">
        and RES.deployment_id_ in
        <foreach item="item" index="index" collection="deploymentIds" open="(" separator="," close=")">
          #{item}
        </foreach>
      </if>
      <if test="latest">
        and RES.version_ = (select max(version_) from ${prefix}t_wf_re_procdef where key_ = RES.key_
             <if test="tenantId != null">
	           and tenant_id_ = #{tenantId}
	         </if>
	         <if test="tenantIdLike != null">
	           and tenant_id_ like #{tenantIdLike}${wildcardEscapeClause}
	         </if>
	         <if test="withoutTenantId">
	           and (tenant_id_ = '' or tenant_id_ is null)
	         </if>
	         <if test="tenantId == null and tenantIdLike == null and !withoutTenantId">
	           and ( (tenant_id_ IS NOT NULL and tenant_id_ = RES.tenant_id_) or (tenant_id_ IS NULL and RES.tenant_id_ IS NULL) )
	         </if>
        )
      </if>
      <if test="suspensionState != null">
        and (RES.suspension_state_ = #{suspensionState.stateCode})
      </if>
       <if test="tenantId != null">
        and RES.tenant_id_ = #{tenantId}
      </if>
      <if test="tenantIdLike != null">
        and RES.tenant_id_ like #{tenantIdLike}${wildcardEscapeClause}
      </if>
      <if test="withoutTenantId">
        and (RES.tenant_id_ = '' or RES.TENANT_ID_ is null)
      </if>
      <if test="eventSubscriptionType != null">
      	and (evt.event_type_ = #{eventSubscriptionType} and evt.event_name_ = #{eventSubscriptionName})
      </if>
      <if test="authorizationUserId != null">
        AND (exists (select id_  from ${prefix}t_wf_ru_identitylink  idn where idn.proc_def_id_ = RES.id_ and idn.user_id_ = #{authorizationUserId})
        <if test="authorizationGroups != null &amp;&amp; authorizationGroups.size() &gt; 0">
         OR exists (select id_ from ${prefix}t_wf_ru_identitylink  idn where idn.proc_def_id_ = RES.id_ and idn.group_id_ IN
            <foreach item="group" index="index" collection="authorizationGroups" 
                     open="(" separator="," close=")">
              #{group}
            </foreach>
         )
         </if>
          <!-- by lw -->
          <if test="authorizationOrgs != null &amp;&amp; authorizationOrgs.size() &gt; 0">
         OR exists (select id_ from ${prefix}t_wf_ru_identitylink  idn where idn.proc_def_id_ = RES.id_ and idn.org_id_ IN
            <foreach item="org" index="index" collection="authorizationOrgs" 
                     open="(" separator="," close=")">
              #{org}
            </foreach>
         )
         </if>
        )
      </if>
    </where>
  </sql>
    
  <select id="selectProcessDefinitionByDeploymentAndKey" parameterType="map" resultMap="processDefinitionResultMap">
    select * 
    from ${prefix}t_wf_re_procdef
    where deployment_id_ = #{deploymentId}
      and key_ = #{processDefinitionKey}
      and (tenant_id_ = '' or tenant_id_ is null)
  </select>
  
   <select id="selectProcessDefinitionByDeploymentAndKeyAndTenantId" parameterType="map" resultMap="processDefinitionResultMap">
    select * 
    from ${prefix}t_wf_re_procdef
    where deployment_id_ = #{deploymentId}
      and key_ = #{processDefinitionKey}
      and tenant_id_ = #{tenantId}
  </select>
    
  <select id="selectLatestProcessDefinitionByKey" parameterType="string" resultMap="processDefinitionResultMap">
    select *
    from ${prefix}t_wf_re_procdef
    where key_ = #{key} and
          (tenant_id_ = ''  or tenant_id_ is null) and
          version_ = (select max(version_) from ${prefix}t_wf_re_procdef where key_ = #{processDefinitionKey} and (tenant_id_ = '' or tenant_id_ is null))
  </select>
  
  <select id="selectLatestProcessDefinitionByKeyAndTenantId" parameterType="map" resultMap="processDefinitionResultMap">
    select *
    from ${prefix}t_wf_re_procdef
    where key_ = #{processDefinitionKey} and
          tenant_id_ = #{tenantId} and
          version_ = (select max(version_) from ${prefix}t_wf_re_procdef where key_ = #{processDefinitionKey} and tenant_id_ = #{tenantId})
  </select>
  
  <!-- mysql specific sql -->
  <select id="selectProcessDefinitionsByQueryCriteria_mysql" parameterType="org.activiti.engine.impl.ProcessDefinitionQueryImpl" resultMap="processDefinitionResultMap">
  	${limitBefore}
    select distinct RES.* ${limitBetween}
    <include refid="selectProcessDefinitionsByQueryCriteriaSql"/>
    ${orderBy}
    ${limitAfter}
  </select>

  <!-- mysql specific sql -->
  <select id="selectProcessDefinitionCountByQueryCriteria_mysql" parameterType="org.activiti.engine.impl.ProcessDefinitionQueryImpl" resultType="long">
    select distinct count(RES.id_)
    <include refid="selectProcessDefinitionsByQueryCriteriaSql"/>
  </select>

  <select id="selectProcessDefinitionByNativeQuery" parameterType="java.util.Map" resultMap="processDefinitionResultMap">
    <if test="resultType == 'LIST_PAGE'">
      ${limitBefore}
    </if>
    ${sql}
    <if test="resultType == 'LIST_PAGE'">
      ${limitAfter}
    </if>
  </select>

  <select id="selectProcessDefinitionByNativeQuery_mssql_or_db2" parameterType="java.util.Map" resultMap="processDefinitionResultMap">
    <if test="resultType == 'LIST_PAGE'">
      ${limitBeforeNativeQuery}
    </if>
    ${sql}
    <if test="resultType == 'LIST_PAGE'">
      ${limitAfter}
    </if>
  </select>

  <select id="selectProcessDefinitionCountByNativeQuery" parameterType="java.util.Map" resultType="long">
    ${sql}
  </select>
</mapper>