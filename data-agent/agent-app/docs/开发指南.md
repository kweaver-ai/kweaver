# 开发指南

## 项目结构

Agent-App 采用领域驱动设计(DDD)架构，目录结构清晰：

```
/root/go/src/DIP/agent-app/
├── conf/                    # 配置管理
├── src/                    # 源代码目录
│   ├── boot/              # 启动初始化
│   ├── domain/            # 领域层 (DDD核心)
│   │   ├── entity/        # 实体
│   │   ├── valueobject/   # 值对象
│   │   ├── service/       # 领域服务
│   │   ├── enum/          # 枚举
│   │   └── constant/      # 常量
│   ├── driveradapter/     # 驱动适配器 (API层)
│   │   └── api/httphandler/
│   ├── drivenadapter/     # 被驱动适配器 (外部服务调用)
│   ├── infra/             # 基础设施层
│   │   ├── server/        # HTTP服务器
│   │   ├── persistence/   # 持久化
│   │   └── common/        # 通用工具
│   └── port/              # 端口层 (DDD端口)
├── deploy/                # 部署配置
├── helm/                  # Helm Chart
├── migrations/            # 数据库迁移脚本
├── locale/                # 本地化资源
└── version/               # 版本信息
```

## 开发环境搭建

### 1. 环境要求

- Go 1.23.7+
- Docker & Docker Compose
- Git
- 访问公司内部仓库权限

### 2. 依赖安装

```bash
# 进入开发容器
docker exec -it agent-app_dev bash

# 安装依赖
go mod download
go mod tidy
```

### 3. 本地运行

```bash
# 在开发容器中运行
go run main.go

# 或者使用热重载
go run main.go --watch
```

## 代码规范

### 命名规范

- **包名**: 小写，单数形式
- **文件名**: 小写，下划线分隔
- **结构体**: 大驼峰命名
- **变量**: 小驼峰命名
- **常量**: 大写，下划线分隔

### 代码组织

#### 领域层 (Domain Layer)

```go
// 实体定义示例
package entity

type ConversationEO struct {
    ID           string
    Title        string
    AgentAPPKey  string
    MessageIndex int
    CreateTime   int64
    UpdateTime   int64
}

// 值对象定义示例
package valueobject

type AgentInfoVO struct {
    AgentID      string
    AgentName    string
    AgentStatus  string
    AgentVersion string
}
```

#### 应用层 (Application Layer)

```go
// 服务接口定义
package service

type AgentService interface {
    Chat(ctx context.Context, req *ChatReq) (chan []byte, error)
    Debug(ctx context.Context, req *DebugReq) (chan []byte, error)
}
```

#### 基础设施层 (Infrastructure Layer)

```go
// 数据访问对象
package dapo

type ConversationMsgPO struct {
    ID             string
    ConversationID string
    AgentAPPKey    string
    AgentID        string
    AgentVersion   string
    Role           cdaenum.MsgRole
    Index          int
    Content        *string
    ContentType    cdaenum.ConversationMsgContentType
    Status         cdaenum.MsgStatus
    Ext            *string
    CreateTime     int64
    UpdateTime     int64
    CreateBy       string
    UpdateBy       string
}
```

## 核心开发概念

### 1. 对话处理流程

对话处理是项目的核心功能，主要流程如下：

```go
// 1. 获取Agent配置
agent, err := agentSvc.agentFactory.GetAgent(ctx, req.AgentID, req.AgentVersion)

// 2. 获取历史上下文
conversationPO, contexts, msgIndex, err := agentSvc.GetHistoryAndMsgIndex(ctx, req)

// 3. 插入用户和助手消息
req.UserMessageID, req.AssistantMessageID, req.AssistantMessageIndex, err =
    agentSvc.UpsertUserAndAssistantMsg(ctx, req, msgIndex, conversationPO)

// 4. 生成Agent调用请求
agentCallReq, err := agentSvc.GenerateAgentCallReq(ctx, req, contexts, agent)

// 5. 调用Agent Executor
messageChan, errChan, err := agentCall.Call()

// 6. 流式处理响应
go agentSvc.Process(req, agent, stopChan, channel, messageChan, errChan, agentCall.Cancel)
```

### 2. 流式处理机制

流式处理使用通道(Channel)实现：

```go
// 创建响应通道
channel := make(chan []byte, CHANNEL_SIZE)

// 流式处理协程
go func() {
    defer close(channel)

    for {
        select {
        case msg, more := <-messageChan:
            if !more {
                return
            }
            // 处理消息
            currentData, isEnd, err := agentSvc.AfterProcess(ctx, []byte(message), req, &agent)

            // 流式传输
            if req.Stream {
                if req.IncStream {
                    StreamDiff(ctx, seq, lastData, currentData, respChan)
                } else {
                    respChan <- formatSSEMessage(string(currentData))
                }
            }
        case <-stopChan:
            // 处理终止信号
            return
        }
    }
}()
```

### 3. 会话管理

会话管理涉及多个实体和状态：

```go
// 会话实体
conversationPO := &dapo.ConversationPO{
    AgentAPPKey: req.AgentAPPKey,
    Title:       "新会话",
    CreateBy:    req.UserID,
    UpdateBy:    req.UserID,
    Ext:         new(string),
}

// 消息实体
conversationUserMsgPO := &dapo.ConversationMsgPO{
    ConversationID: req.ConversationID,
    AgentAPPKey:    req.AgentAPPKey,
    AgentID:        req.AgentID,
    AgentVersion:   req.AgentVersion,
    Index:          msgIndex + 1,
    Role:           cdaenum.MsgRoleUser,
    Content:        &userContentStr,
    ContentType:    cdaenum.MsgText,
    Status:         cdaenum.MsgStatusProcessed,
}
```

## 测试指南

### 单元测试

```bash
# 运行所有测试
go test ./...

# 运行特定包的测试
go test ./src/domain/service/agentsvc

# 运行测试并生成覆盖率报告
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

### 集成测试

```bash
# 启动测试环境
docker-compose -f deploy/compose-test.yaml up -d

# 运行集成测试
go test -tags=integration ./...
```

### 性能测试

```bash
# 使用 benchmark 测试
go test -bench=. -benchmem ./...
```

## 调试技巧

### 1. 日志调试

项目使用结构化日志，支持多级别日志输出：

```go
// 在代码中添加调试日志
agentSvc.logger.Infof("[Chat] processing request for agent: %s", req.AgentID)
agentSvc.logger.Debugf("[Chat] conversation context: %+v", contexts)
agentSvc.logger.Errorf("[Chat] error occurred: %v", err)
```

### 2. 可观测性

集成 OpenTelemetry 进行分布式追踪：

```go
// 创建追踪span
ctx, span := o11y.StartInternalSpan(ctx)
defer o11y.EndSpan(ctx, err)

// 设置追踪属性
o11y.SetAttributes(ctx, attribute.String("agent_id", req.AgentID))
o11y.SetAttributes(ctx, attribute.String("user_id", req.UserID))
```

### 3. 性能分析

使用 pprof 进行性能分析：

```bash
# 启动 pprof 服务
import _ "net/http/pprof"

go func() {
    log.Println(http.ListenAndServe("localhost:6060", nil))
}()

# 分析性能
go tool pprof http://localhost:6060/debug/pprof/profile
```

## 部署和发布

### 1. 构建镜像

```bash
# 构建 Docker 镜像
docker build -t agent-app:latest .

# 使用多阶段构建优化镜像大小
docker build -t agent-app:optimized -f Dockerfile.optimized .
```

### 2. Helm 部署

```bash
# 部署到 Kubernetes
helm install agent-app ./helm/agent-app

# 升级部署
helm upgrade agent-app ./helm/agent-app

# 回滚部署
helm rollback agent-app 1
```

### 3. 配置管理

使用 ConfigMap 和 Secret 管理配置：

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: agent-app-config
data:
  config.yaml: |
    database:
      host: mysql-service
      port: 3306
    observability:
      enabled: true
      level: info
```

## 常见问题解决

### 1. 依赖问题

```bash
# 清理依赖缓存
go clean -modcache

# 重新下载依赖
go mod download

# 更新依赖版本
go get -u package_name
```

### 2. 数据库连接问题

- 检查数据库服务状态
- 验证连接字符串格式
- 检查网络连通性
- 查看数据库日志

### 3. 性能问题

- 使用 pprof 分析性能瓶颈
- 检查数据库查询性能
- 优化连接池配置
- 监控内存使用情况

## 贡献指南

### 1. 代码提交

```bash
# 创建功能分支
git checkout -b feature/your-feature-name

# 提交代码
git add .
git commit -m "feat: add new feature"

# 推送分支
git push origin feature/your-feature-name
```

### 2. 代码审查

- 确保代码符合规范
- 添加适当的测试用例
- 更新相关文档
- 通过 CI/CD 流水线

### 3. 发布流程

1. 创建发布分支
2. 更新版本号
3. 运行完整测试
4. 构建发布镜像
5. 部署到生产环境

---

*最后更新: 2025-11-13*