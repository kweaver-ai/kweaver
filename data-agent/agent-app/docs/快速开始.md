# 快速开始指南

## 环境要求

- Go 1.23.7 或更高版本
- Docker 和 Docker Compose
- MySQL 数据库
- 访问公司内部依赖仓库的权限

## 快速部署

### 1. 克隆项目

```bash
git clone <项目地址>
cd agent-app
```

### 2. 环境配置

项目使用 Docker Compose 进行开发环境部署：

```bash
# 启动开发环境
docker-compose -f deploy/compose.yaml up -d
```

开发环境将在端口 `30777` 启动。

### 3. 配置数据库

确保 MySQL 数据库已配置并运行。项目使用以下配置：

- 数据库驱动: MySQL
- 连接池: 通过 `proton-rds-sdk-go` 管理
- 迁移脚本: 位于 `migrations/` 目录

### 4. 运行应用

```bash
# 进入开发容器
docker exec -it agent-app_dev bash

# 在容器内运行应用
cd /root/agent-app
go run main.go
```

## 基本使用

### 1. 对话接口

Agent-App 提供智能对话功能，支持流式响应：

```bash
curl -X POST \
  http://localhost:30777/api/agent-app/v1/app/{app_key}/api/chat/completion \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "your_agent_id",
    "agent_version": "latest",
    "stream": true,
    "inc_stream": true,
    "query": "你好，请介绍一下这个项目",
    "chat_mode": "normal",
    "history": [
      {
        "role": "user",
        "content": "之前的问题"
      },
      {
        "role": "assistant",
        "content": "之前的回答"
      }
    ]
  }'
```

### 2. 会话管理

获取会话列表：

```bash
curl -X GET \
  "http://localhost:30777/api/agent-app/v1/app/{app_key}/conversations?page=1&page_size=20" \
  -H "Authorization: Bearer your_token"
```

获取会话详情：

```bash
curl -X GET \
  "http://localhost:30777/api/agent-app/v1/app/{app_key}/conversations/{conversation_id}" \
  -H "Authorization: Bearer your_token"
```

### 3. 调试功能

Agent 调试接口：

```bash
curl -X POST \
  http://localhost:30777/api/agent-app/v1/app/{app_key}/api/debug \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "your_agent_id",
    "input": {
      "query": "测试问题",
      "temp_files": [],
      "history": [],
      "tool": {},
      "custom_querys": {}
    },
    "chat_mode": "normal"
  }'
```

### 4. 临时区域管理

创建临时区域：

```bash
curl -X POST \
  http://localhost:30777/api/agent-app/v1/app/{app_key}/temporary-area \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "我的临时区域",
    "description": "用于存储临时文件"
  }'
```

## 配置说明

### 应用配置

主要配置文件：
- `agent-api.yaml` - OpenAPI 3.0 规范
- `conf/config.go` - 配置结构定义

### 环境变量

支持通过环境变量配置：
- `LOG_LEVEL` - 日志级别
- `DATABASE_URL` - 数据库连接字符串
- `AGENT_FACTORY_URL` - Agent Factory 服务地址
- `AGENT_EXECUTOR_URL` - Agent Executor 服务地址

### 可观测性配置

可观测性配置通过 `/sysvol/conf/observability.yaml` 加载，包括：
- 日志配置
- 监控配置
- 追踪配置

## 健康检查

应用提供健康检查接口：

```bash
curl http://localhost:30777/health
```

## 故障排除

### 常见问题

1. **端口冲突**
   - 确保端口 30777 未被占用
   - 修改 `deploy/compose.yaml` 中的端口映射

2. **数据库连接失败**
   - 检查数据库服务是否运行
   - 验证数据库连接配置

3. **依赖包下载失败**
   - 确保有访问公司内部仓库的权限
   - 检查网络连接

### 日志查看

应用日志输出到：
```bash
/app/agent-app/logs/agent-app.log
```

在开发容器中查看：
```bash
docker exec -it agent-app_dev tail -f /app/agent-app/logs/agent-app.log
```

## 使用场景示例

### 场景1: 智能客服助手

```bash
# 创建客服会话
curl -X POST \
  http://localhost:30777/api/agent-app/v1/app/customer_service/api/chat/completion \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "customer_service_agent",
    "query": "我的订单什么时候发货？",
    "stream": true,
    "temp_files": [
      {
        "id": "order_info_001",
        "name": "order_details.pdf",
        "type": "doc"
      }
    ]
  }'
```

### 场景2: 多轮技术咨询

```bash
# 继续之前的对话
curl -X POST \
  http://localhost:30777/api/agent-app/v1/app/tech_support/api/chat/completion \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "tech_support_agent",
    "conversation_id": "tech_conv_001",
    "query": "按照刚才的建议，我该如何配置？",
    "stream": true
  }'
```

### 场景3: 文档分析助手

```bash
# 分析文档内容
curl -X POST \
  http://localhost:30777/api/agent-app/v1/app/doc_analysis/api/chat/completion \
  -H "Authorization: Bearer your_token" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": "doc_analysis_agent",
    "query": "请分析这个文档的主要内容",
    "temp_files": [
      {
        "id": "doc_001",
        "name": "technical_spec.pdf",
        "type": "doc"
      }
    ],
    "data_source": {
      "doc": [
        {
          "ds_id": "document_repository",
          "fields": [
            {
              "name": "content",
              "path": "text",
              "source": "document"
            }
          ],
          "datasets": ["tech_docs"]
        }
      ]
    }
  }'
```

## 最佳实践

### 1. 会话管理
- 合理使用 `conversation_id` 维护多轮对话上下文
- 定期清理过期会话以释放资源
- 使用会话列表接口监控对话活跃度

### 2. 流式响应处理
- 客户端实现重连机制处理网络中断
- 使用增量流式减少网络带宽使用
- 及时关闭SSE连接释放服务器资源

### 3. 错误处理
- 实现重试逻辑处理临时性错误
- 监控错误码和错误信息
- 使用调试接口排查问题

### 4. 性能优化
- 合理设置历史记录长度
- 使用合适的对话模式（normal/deep_thinking）
- 优化数据源配置减少检索时间

## 下一步

- 了解 [核心功能](./核心功能.md) 的详细说明
- 查看 [API设计](./API设计.md) 了解完整的接口文档
- 阅读 [开发指南](./开发指南.md) 进行二次开发
- 学习 [Agent开发指南](./Agent开发指南.md) 创建自定义Agent

---

*最后更新: 2025-11-13*