# 架构设计文档

## 系统架构概述

Agent-App 采用**领域驱动设计(DDD)**和**六边形架构**，构建了一个高度可扩展、可维护的智能体应用平台。系统通过清晰的领域边界和分层设计，实现了业务逻辑与技术实现的分离。

## 架构原则

1. **领域驱动**: 以业务领域为核心组织代码
2. **分层架构**: 清晰的职责分离
3. **依赖倒置**: 高层模块不依赖低层模块
4. **可测试性**: 每个组件都可独立测试
5. **可观测性**: 完整的监控和追踪体系

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                   外部调用方 (HTTP Client)                    │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                   驱动适配器层 (Driver Adapter)               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │
│  │   HTTP Handler  │  │   gRPC Handler  │  │  CLI Handler  │ │
│  └─────────────────┘  └─────────────────┘  └───────────────┘ │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                     应用层 (Application)                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │
│  │   Agent Service │  │ConversationSvc  │  │  其他服务     │ │
│  └─────────────────┘  └─────────────────┘  └───────────────┘ │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                     领域层 (Domain)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   实体      │  │  值对象     │  │     领域服务        │ │
│  │ Conversation│  │ AgentInfoVO │  │   Chat, Debug等     │ │
│  │    Message  │  │   MessageVO │  │                     │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                   端口层 (Port)                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │
│  │ Agent Repository│  │  Msg Repository │  │  其他端口     │ │
│  │    Interface    │  │   Interface     │  │               │ │
│  └─────────────────┘  └─────────────────┘  └───────────────┘ │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                 被驱动适配器层 (Driven Adapter)              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │
│  │   MySQL DAO     │  │  HTTP Client    │  │   Kafka       │ │
│  │  Conversation   │  │ Agent Factory   │  │   Producer    │ │
│  │     Message     │  │ Agent Executor  │  │               │ │
│  └─────────────────┘  └─────────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 核心架构组件

### 1. 领域层 (Domain Layer)

#### 实体 (Entities)

- **ConversationEO**: 会话实体
  - ID, Title, AgentAPPKey, MessageIndex
  - CreateTime, UpdateTime, CreateBy, UpdateBy

- **MessageEO**: 消息实体
  - ID, ConversationID, AgentID, AgentVersion
  - Role, Content, ContentType, Status
  - Index, ReplyID, CreateTime, UpdateTime

#### 值对象 (Value Objects)

- **AgentInfoVO**: Agent信息值对象
- **MessageVO**: 消息值对象
- **ChatRespVO**: 对话响应值对象

#### 领域服务 (Domain Services)

- **AgentService**: 核心对话服务
  - `Chat(ctx, req)`: 处理对话请求
  - `Debug(ctx, req)`: 处理调试请求
  - `Process()`: 流式处理逻辑

- **ConversationService**: 会话管理服务
  - 会话创建、查询、更新、删除
  - 消息管理和历史上下文

### 2. 应用层 (Application Layer)

#### 服务协调

应用层负责协调领域对象和外部服务，实现业务用例：

```go
// 对话用例协调
type ChatUseCase struct {
    agentRepo      AgentRepository
    conversationRepo ConversationRepository
    agentExecutor  AgentExecutor
}

func (uc *ChatUseCase) Execute(ctx context.Context, req ChatRequest) (ChatResponse, error) {
    // 1. 验证请求
    // 2. 获取Agent配置
    // 3. 处理会话
    // 4. 调用外部服务
    // 5. 返回响应
}
```

### 3. 基础设施层 (Infrastructure Layer)

#### 数据持久化

- **MySQL**: 主要数据存储
- **数据访问对象 (DAO)**:
  - `ConversationDAO`: 会话数据访问
  - `MessageDAO`: 消息数据访问
  - `AgentConfigDAO`: Agent配置访问

#### 外部服务集成

- **Agent Factory**: Agent配置管理服务
- **Agent Executor**: Agent执行服务
- **Efast**: 快速服务
- **Docset**: 文档集服务

#### 消息队列

- **Kafka**: 异步消息处理
- 事件发布/订阅模式
- 保证最终一致性

### 4. 接口适配器层 (Interface Adapters)

#### HTTP 适配器

```go
// HTTP Handler 示例
type AgentHTTPHandler struct {
    agentService AgentService
}

func (h *AgentHTTPHandler) Chat(c *gin.Context) {
    // 1. 解析请求
    // 2. 调用应用服务
    // 3. 处理响应
    // 4. 返回HTTP响应
}
```

#### gRPC 适配器

支持 gRPC 协议，用于内部服务通信。

## 数据流设计

### 对话处理数据流

```
1. HTTP请求 → 2. HTTP Handler → 3. Agent Service → 4. 会话管理
                    ↓
5. Agent Factory → 6. 历史上下文 → 7. 消息持久化
                    ↓
8. Agent Executor → 9. 流式处理 → 10. SSE响应
```

### 详细处理流程

1. **请求接收** (HTTP Handler)
   - 验证认证信息
   - 解析请求参数
   - 构建领域请求对象

2. **业务处理** (Agent Service)
   - 获取Agent配置 (Agent Factory)
   - 处理会话和消息 (Conversation Service)
   - 生成调用请求

3. **外部调用** (Agent Executor)
   - 调用大模型服务
   - 流式接收响应
   - 错误处理和重试

4. **响应处理** (Stream Processing)
   - 流式数据解析
   - 增量传输处理
   - 状态更新和持久化

## 技术架构

### 1. Web 框架

- **Gin**: 高性能 HTTP Web 框架
- 中间件支持: 认证、日志、限流等
- 优雅关闭和健康检查

### 2. 数据访问

- **proton-rds-sdk-go**: MySQL 数据库访问 SDK
- 连接池管理
- 事务支持
- 读写分离

### 3. 配置管理

- **Viper**: 配置管理库
- 支持多种配置源
- 环境变量覆盖
- 热重载支持

### 4. 序列化

- **Sonic**: 高性能 JSON 序列化
- 替代标准 encoding/json
- 显著提升序列化性能

### 5. 可观测性

- **OpenTelemetry**: 分布式追踪
- 结构化日志
- 指标收集
- 性能监控

## 部署架构

### 1. 容器化部署

```yaml
# Docker Compose 配置
services:
  agent-app:
    image: agent-app:latest
    ports:
      - "30777:30777"
    environment:
      - DATABASE_URL=mysql://user:pass@mysql:3306/agent_app
      - LOG_LEVEL=info
    depends_on:
      - mysql
```

### 2. Kubernetes 部署

```yaml
# Helm Chart 配置
apiVersion: apps/v1
kind: Deployment
metadata:
  name: agent-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: agent-app
  template:
    metadata:
      labels:
        app: agent-app
    spec:
      containers:
      - name: agent-app
        image: agent-app:latest
        ports:
        - containerPort: 30777
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: agent-app-secret
              key: database-url
```

### 3. 服务发现和负载均衡

- **Kubernetes Service**: 内部服务发现
- **Ingress**: 外部访问入口
- **Load Balancer**: 负载均衡

## 性能优化架构

### 1. 缓存策略

- **Redis**: 会话缓存
- **本地缓存**: 配置缓存
- **CDN**: 静态资源缓存

### 2. 数据库优化

- **读写分离**: 主从复制
- **分库分表**: 水平扩展
- **索引优化**: 查询性能

### 3. 流式处理优化

- **增量传输**: 减少网络开销
- **批量处理**: 提高处理效率
- **连接复用**: 减少连接建立

## 安全架构

### 1. 认证和授权

- **JWT Token**: 用户认证
- **RBAC**: 基于角色的访问控制
- **API Key**: 应用认证

### 2. 数据安全

- **TLS/SSL**: 传输加密
- **数据加密**: 敏感数据加密
- **访问日志**: 安全审计

### 3. 网络安全

- **防火墙**: 网络访问控制
- **WAF**: Web应用防火墙
- **DDoS防护**: 流量清洗

## 监控和告警

### 1. 监控指标

- **应用指标**: QPS, 响应时间, 错误率
- **系统指标**: CPU, 内存, 磁盘, 网络
- **业务指标**: 对话成功率, 用户活跃度

### 2. 日志系统

- **结构化日志**: JSON格式
- **日志聚合**: ELK Stack
- **日志分析**: 异常检测

### 3. 告警机制

- **阈值告警**: 性能指标告警
- **异常检测**: 智能异常检测
- **多渠道通知**: 邮件、短信、钉钉

## 扩展性设计

### 1. 水平扩展

- **无状态设计**: 支持多实例部署
- **会话亲和性**: 保证用户体验
- **数据分片**: 支持大数据量

### 2. 垂直扩展

- **资源隔离**: 不同服务独立部署
- **微服务化**: 功能模块拆分
- **服务网格**: 服务间通信管理

### 3. 功能扩展

- **插件架构**: 支持功能插件
- **配置化**: 动态配置更新
- **API扩展**: 向后兼容的API设计

---

*最后更新: 2025-11-13*