# 核心功能

## Agent对话

Agent-App 提供完整的智能对话能力，支持多种对话模式和场景。

### 1. 普通对话

**功能描述**: 基础的问答式对话，适用于简单查询和一次性交互场景。

**使用场景**:
- 快速问答和单次查询
- 无需上下文记忆的简单任务
- 功能测试和快速验证

**技术实现**:
- 无状态对话处理
- 实时响应机制
- 支持多种输入格式（文本、文件等）

**请求示例**:
```json
{
  "agent_id": "your_agent_id",
  "query": "你好，请介绍一下这个项目",
  "stream": true
}
```

### 2. 含历史记录上下文多轮对话

**功能描述**: 支持基于历史上下文的连续对话，能够记住之前的对话内容并基于上下文进行回应。

#### 2.1 用户自己维护对话历史记录

**实现方式**:
- 用户端存储和管理对话历史
- 每次请求携带完整历史记录
- 灵活控制上下文长度

**适用场景**:
- 移动端应用集成
- 需要自定义历史管理的场景
- 分布式系统集成

**请求示例**:
```json
{
  "agent_id": "your_agent_id",
  "query": "继续刚才的话题",
  "history": [
    {"role": "user", "content": "什么是AI？"},
    {"role": "assistant", "content": "AI是人工智能的缩写..."}
  ]
}
```

#### 2.2 使用会话中的历史记录

**实现方式**:
- 平台自动维护会话历史
- 基于会话ID关联历史记录
- 自动上下文截断和优化

**适用场景**:
- Web应用集成
- 需要平台统一管理的场景
- 长期对话项目

**请求示例**:
```json
{
  "agent_id": "your_agent_id",
  "conversation_id": "conv_123456",
  "query": "继续刚才的话题"
}
```

### 3. API 对话

**功能描述**: 将Agent能力封装为API服务，支持外部系统集成调用。

#### 3.1 API 对话的会话管理

**会话生命周期**:
- **创建会话**: 初始化新的对话会话
- **会话维护**: 自动维护会话状态和上下文
- **会话清理**: 自动清理过期会话

**会话特性**:
- 唯一会话ID标识
- 会话超时机制
- 会话数据持久化

#### 3.2 API 对话使用

**调用流程**:
1. 获取API端点
2. 初始化会话
3. 发送对话请求
4. 处理响应结果

**请求参数**:
```json
{
  "session_id": "会话标识",
  "message": "用户输入",
  "parameters": "额外参数"
}
```

### 4. 含人工干预的对话

**功能描述**: 支持人工介入对话流程，在关键节点进行人工审核或干预。

**使用场景**:
- 敏感内容审核
- 复杂问题人工处理
- 质量控制和优化

**干预机制**:
- 干预点配置
- 人工审核流程
- 结果反馈机制

### 5. 调试

**功能描述**: 提供完整的调试工具和监控能力，帮助开发者优化Agent性能。

**使用场景**:
- Agent功能测试
- 性能调优
- 问题排查

**调试工具**:
- 实时日志查看
- 性能监控面板
- 错误追踪系统

**调试特性**:
- 逐步执行调试
- 变量状态查看
- 调用链追踪

## 会话管理

### 1. 会话消息管理

**功能描述**: 完整的会话消息生命周期管理，包括存储、检索、更新和删除。

**消息存储**:
- 结构化消息存储
- 消息索引优化
- 历史消息归档

**消息操作**:
- 消息添加
- 消息查询
- 消息删除
- 消息更新

**消息状态流转**:
- `MsgStatusProcessing`: 处理中
- `MsgStatusSucceded`: 成功完成
- `MsgStatusFailed`: 处理失败
- `MsgStatusCancelled`: 已取消
- `MsgStatusReceived`: 已接收
- `MsgStatusProcessed`: 已处理

### 2. 会话临时区管理

**功能描述**: 管理用户上传的文件，为文档问答场景提供文件存储和引用机制。临时区存储上传文件的ID，在对话中引用这些文件进行问答，最终在对话结束时将临时区绑定到会话。

**临时区工作流程**:
1. **文件上传**: 用户先将文件上传到临时区，获取文件ID
2. **对话引用**: 在对话请求中传入临时区ID和相关文件信息
3. **文档问答**: Agent基于临时区中的文件内容进行问答
4. **会话绑定**: 对话结束时，临时区自动绑定到对应的会话

**临时区内容**:
- 用户上传的文件ID列表
- 文件元数据（名称、类型、大小等）
- 会话关联信息

**管理策略**:
- **自动绑定**: 对话结束时自动将临时区绑定到会话
- **文件验证**: 上传时验证文件类型和大小
- **生命周期管理**: 临时区有明确的创建、使用、绑定生命周期

**临时区创建示例**:
```json
{
  "name": "文档分析临时区",
  "description": "用于存储待分析的文档文件",
  "sources": [
    {
      "source_id": "file_001",
      "source_type": "doc",
      "name": "技术文档.pdf"
    }
  ]
}
```

**对话中使用临时区示例**:
```json
{
  "agent_id": "doc_analysis_agent",
  "query": "请分析这个文档的主要内容",
  "temporary_area_id": "temp_area_123",
  "temp_files": [
    {
      "id": "file_001",
      "name": "技术文档.pdf",
      "type": "doc"
    }
  ]
}
```

**技术实现细节**:
- **数据模型**: `TempAreaPO` 结构包含ID、会话ID、文件源信息等字段
- **文件验证**: 在创建临时区时验证文件类型和大小限制
- **绑定机制**: 通过 `Bind` 方法在对话结束后将临时区绑定到会话
- **持久化**: 临时区信息与对话数据一起持久化存储

## 流式响应

支持两种流式响应模式：

1. **增量流式 (IncStream)**: 只传输变化的数据，减少网络传输量
2. **全量流式**: 每次传输完整的响应数据

**流式处理核心逻辑**:
```go
func (agentSvc *agentSvc) Process(req *agentreq.ChatReq, agent agentfactorydto.Agent, stopChan chan struct{},
respChan chan []byte, messageChan chan string, errChan chan error, cancelFunc func()) error
```

## 性能优化特性

### 1. 流式处理优化
- **增量传输**: 减少网络带宽使用
- **批量处理**: 每5次流式传输进行一次差异计算
- **连接管理**: 支持SSE长连接

### 2. 缓存策略
- **会话缓存**: 减少数据库访问
- **进度缓存**: 缓存处理进度状态
- **配置缓存**: 缓存Agent配置

### 3. 数据库优化
- **连接池**: 数据库连接复用
- **索引优化**: 关键字段索引
- **批量操作**: 减少数据库事务

## 对话模式

### 普通模式 (Normal Mode)

默认对话模式，使用标准大模型进行响应。

### 深度思考模式 (Deep Thinking Mode)

使用推理大模型(RLM)进行深度思考：

```go
// 深度思考模式切换
if req.ChatMode == constant.DeepThinkingMode {
    // 切换到大模型配置
    for _, llm := range agentCallReq.Config.Llms {
        if llm.LlmConfig.ModelType == cdaenum.ModelTypeRlm {
            llm.IsDefault = true
            break
        }
    }
}
```

## 消息编辑和重新生成

### 消息编辑

支持编辑用户消息并重新生成响应：
- 更新用户消息内容
- 重新生成对应的助手消息
- 维护消息关联关系

### 重新生成

支持重新生成助手消息：
- 调整大模型温度参数
- 提高生成多样性
- 支持指定模型名称

## 错误处理

### 错误分类

1. **客户端错误 (4xx)**: 参数错误、权限不足等
2. **服务端错误 (5xx)**: 内部服务错误、依赖服务异常
3. **业务错误**: Agent执行失败、配置错误等

### 错误恢复

- **重试机制**: 对可重试错误进行重试
- **降级策略**: 关键功能降级处理
- **错误上报**: 完整的错误日志和监控

## 监控和可观测性

### 日志系统

- 结构化日志输出
- 多级别日志控制
- 日志文件轮转

### 性能监控

- 请求处理时间统计
- 资源使用监控
- 外部服务调用监控

### 分布式追踪

- OpenTelemetry集成
- 跨服务调用追踪
- 性能瓶颈分析