.PHONY: clean dev-setup test test-unit test-integration test-integration-filter test-legacy help lint format uv-sync uv-clean


# é€šç”¨å®‰è£…å‘½ä»¤ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰

install-dolphin:
	uv add  ../dolphin-language/

install-dolphin2:
	cd /Users/Zhuanz/Work/as/dip_ws/dolphin-language-versions/dolphin-language-5002 && uv pip install . -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn

install-dolphin-edit:
	cd ../dolphin-language && uv pip install -e . -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn

install-dolphin2-edit:
	cd /Users/Zhuanz/Work/as/dip_ws/dolphin-language-versions/dolphin-language-5002_bak && uv pip install -e . -i https://pypi.tuna.tsinghua.edu.cn/simple --trusted-host pypi.tuna.tsinghua.edu.cn


install-proton-mq-python:
	uv add ../proton-mq-python/

install-TelemetrySDK-Python: install-proton-mq-python
	uv pip install -i https://pypi.tuna.tsinghua.edu.cn/simple --upgrade  -r ../TelemetrySDK-Python/pytest_requirements.txt; \
    uv pip install -i https://pypi.tuna.tsinghua.edu.cn/simple --upgrade  -r ../TelemetrySDK-Python/requirements.txt; \
	uv add ../TelemetrySDK-Python/

# è¿è¡Œåº”ç”¨
run:
	PYTHONUNBUFFERED=1 uv run python main.py

# æ¸…ç†æ„å»ºäº§ç‰©å’Œç¼“å­˜æ–‡ä»¶
clean:
	rm -rf dist
	rm -rf build/agent-executor
	#rm -rf *.spec
	rm -rf *.pyc
	rm -rf **/*.pyc
	rm -rf **/**/*.pyc
	rm -rf **/**/**/*.pyc
	rm -rf **/**/**/**/*.pyc
	rm -rf *.egg-info
	rm -rf **/*.egg-info
	rm -rf **/**/*.egg-info
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type d -name ".pytest_cache" -exec rm -rf {} +
	find . -type d -name ".coverage" -exec rm -rf {} +
	find . -type d -name ".mypy_cache" -exec rm -rf {} +
	rm -rf htmlcov/
	rm -rf .coverage
	rm -rf .pytest_cache
	rm -rf .mypy_cache
	@echo "âœ… æ¸…ç†å®Œæˆ"

# å¼€å‘ç¯å¢ƒè®¾ç½®
dev-setup: uv-sync
	@echo "ğŸš€ å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆ"
	@echo "ğŸ§ª è¿è¡Œ 'make test' æ¥éªŒè¯ç¯å¢ƒ"

# æµ‹è¯•ç›¸å…³
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	uv run pytest test/ -v

test-unit:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	uv run pytest test/unit/ -v

test-integration:
	@echo "ğŸ§ª è¿è¡Œé›†æˆæµ‹è¯•..."
	uv run pytest test/integration/ -v

test-integration-filter:
	@echo "ğŸ§ª è¿è¡Œè¿‡æ»¤é›†æˆæµ‹è¯•..."
	@echo "ä½¿ç”¨æ–¹æ³•: make test-integration-filter FILTER=<pattern>"
	@echo "ç¤ºä¾‹: make test-integration-filter FILTER=poem"
	uv run pytest test/integration/ -v -k "$(FILTER)"

test-legacy:
	uv run python run_tests.py --legacy

test-verbose:
	@echo "ğŸ§ª è¯¦ç»†æ¨¡å¼è¿è¡Œæµ‹è¯•..."
	uv run pytest test/ -v -s

# ä»£ç è´¨é‡æ£€æŸ¥
lint:
	@echo "ğŸ” æ£€æŸ¥ä»£ç è´¨é‡..."
	@if uv run which ruff >/dev/null 2>&1; then \
		uv run ruff check --fix app test; \
		uv run ruff format app test; \
	else \
		echo "âš ï¸  ruff æœªå®‰è£…ï¼Œè·³è¿‡ä»£ç æ£€æŸ¥"; \
	fi

# ä»£ç æ ¼å¼åŒ–
format:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	@if uv run which ruff >/dev/null 2>&1; then \
		uv run ruff format app test; \
	else \
		echo "âš ï¸  black æœªå®‰è£…ï¼Œè·³è¿‡ä»£ç æ ¼å¼åŒ–"; \
	fi

# UV ç‰¹å®šæ“ä½œ
uv-sync:
	uv sync --all-groups
	@echo "âœ… UV ç¯å¢ƒåŒæ­¥å®Œæˆ"

uv-clean:
	uv cache clean
	rm -rf .venv
	@echo "âœ… UV ç¼“å­˜æ¸…ç†å®Œæˆ"

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸš€ Agent-Executor - Makefile å¸®åŠ©"
	@echo ""
	@echo "ğŸ”§ å®‰è£…:"
	@echo "  install-dolphin-local      - å®‰è£…æœ¬åœ° Dolphin SDKï¼ˆç›¸å¯¹è·¯å¾„ï¼‰"
	@echo "  install-proton-mq-python-local - å®‰è£…æœ¬åœ° Proton MQï¼ˆç›¸å¯¹è·¯å¾„ï¼‰"
	@echo "  install-TelemetrySDK-Python - å®‰è£…æœ¬åœ° Telemetry SDKï¼ˆç›¸å¯¹è·¯å¾„ï¼‰"
	@echo "  dev-setup            - è®¾ç½®å¼€å‘ç¯å¢ƒ"
	@echo ""
	@echo "  clean                - æ¸…ç†æ„å»ºäº§ç‰©å’Œç¼“å­˜"
	@echo ""
	@echo "ğŸ§ª æµ‹è¯•:"
	@echo "  test                 - è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  test-unit            - è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  test-integration     - è¿è¡Œé›†æˆæµ‹è¯•"
	@echo "  test-integration-filter FILTER=<pattern> - è¿‡æ»¤é›†æˆæµ‹è¯•"
	@echo "  test-legacy          - è¿è¡Œé—ç•™æµ‹è¯•"
	@echo "  test-verbose         - è¯¦ç»†æ¨¡å¼è¿è¡Œæµ‹è¯•"
	@echo ""
	@echo "ğŸ¨ ä»£ç è´¨é‡:"
	@echo "  lint                 - æ£€æŸ¥ä»£ç è´¨é‡"
	@echo "  format               - æ ¼å¼åŒ–ä»£ç "
	@echo ""
	@echo "ğŸš€ UV ç‰¹å®š:"
	@echo "  uv-sync              - åŒæ­¥ UV ç¯å¢ƒä¾èµ–"
	@echo "  uv-clean             - æ¸…ç† UV ç¼“å­˜å’Œè™šæ‹Ÿç¯å¢ƒ"
	@echo ""
	@echo "ğŸ“– ç¤ºä¾‹ç”¨æ³•:"
	@echo "  make dev-setup                    # è®¾ç½®å¼€å‘ç¯å¢ƒ"
	@echo "  make test                         # è¿è¡Œæ‰€æœ‰æµ‹è¯•"
	@echo "  make run                          # è¿è¡Œåº”ç”¨"
	