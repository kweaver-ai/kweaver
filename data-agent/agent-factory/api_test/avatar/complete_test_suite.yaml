name: "头像API完整测试套件"
description: "内置头像API的完整测试套件，包含功能测试、错误处理和性能测试"

variables:
  base_url: "http://127.0.0.1:13022"
  api_prefix: "/api/agent-factory/v3"

variable_config:
  random_number_min: 1000
  random_number_max: 9999
  random_string_length: 8

tests:
  # ========== 头像列表测试 ==========
  - name: "获取头像列表"
    description: "获取所有内置头像的列表信息"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in"
      headers:
        Accept: "application/json"
        X-Request-ID: "${uuid}"
        X-Test-Suite: "complete"
        X-Test-Type: "avatar-list"
    expected:
      status_code: 200
      assertions:
        - type: "exists"
          field: "body.entries"
          message: "响应应该包含entries字段"
        - type: "exists"
          field: "body.total"
          message: "响应应该包含total字段"
        - type: "equals"
          field: "body.total"
          value: 20
          message: "总头像数量应该是20个"
        - type: "length"
          field: "body.entries"
          value: 20
          message: "entries数组长度应该是20"
        - type: "contains"
          field: "headers.content-type"
          value: "application/json"
          message: "Content-Type应该是application/json"
    variable_extraction:
      - name: "avatar_list"
        source: "body"
        path: "entries"
    timeout: "10s"
    retry: 2

  - name: "验证头像列表数据结构"
    description: "验证头像列表中每个头像的数据结构完整性"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in"
      headers:
        Accept: "application/json"
        X-Request-ID: "${uuid}"
        X-Test-Type: "structure-validation"
    expected:
      status_code: 200
      assertions:
        - type: "exists"
          field: "body.entries[0].id"
          message: "头像应该有id字段"

        - type: "exists"
          field: "body.entries[0].url"
          message: "头像应该有url字段"
        - type: "type"
          field: "body.entries[0].id"
          value: "string"
          message: "头像id应该是字符串类型"
        - type: "regex"
          field: "body.entries[0].url"
          value: "/agent-factory/v3/agent/avatar/built-in/([1-9]|1[0-9]|20)"
          message: "URL格式应该正确"
    timeout: "10s"
    retry: 2

  # ========== 单个头像获取测试 ==========
  - name: "获取播放图标(ID=1)"
    description: "获取ID为1的播放图标头像"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/1"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Avatar-ID: "1"
    expected:
      status_code: 200
      assertions:
        - type: "contains"
          field: "headers.content-type"
          value: "image/svg+xml"
          message: "Content-Type应该是image/svg+xml"
        - type: "contains"
          field: "headers.cache-control"
          value: "public, max-age=86400"
          message: "应该设置1天的缓存"
        - type: "contains"
          field: "body"
          value: "<svg"
          message: "响应体应该包含SVG标签"
        - type: "contains"
          field: "body"
          value: "width=\"64\""
          message: "SVG宽度应该是64"
        - type: "contains"
          field: "body"
          value: "fill=\"#4F7EFF\""
          message: "应该包含蓝色背景"
    timeout: "10s"
    retry: 2

  - name: "获取机器人图标(ID=7)"
    description: "获取ID为7的机器人图标头像"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/7"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Avatar-ID: "7"
    expected:
      status_code: 200
      assertions:
        - type: "contains"
          field: "headers.content-type"
          value: "image/svg+xml"
          message: "Content-Type应该是image/svg+xml"
        - type: "contains"
          field: "body"
          value: "<rect"
          message: "机器人图标应该包含矩形元素"
        - type: "contains"
          field: "body"
          value: "<circle"
          message: "机器人图标应该包含圆形元素"
    timeout: "10s"
    retry: 2

  - name: "获取边界值头像(ID=20)"
    description: "获取ID为20的书签图标头像，测试边界值"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/20"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Avatar-ID: "20"
    expected:
      status_code: 200
      assertions:
        - type: "contains"
          field: "headers.content-type"
          value: "image/svg+xml"
          message: "Content-Type应该是image/svg+xml"
        - type: "contains"
          field: "body"
          value: "</svg>"
          message: "SVG应该正确闭合"
    timeout: "10s"
    retry: 2

  # ========== SVG格式验证测试 ==========
  - name: "验证SVG格式完整性"
    description: "验证返回的SVG格式是否完整和有效"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/5"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Type: "svg-validation"
    expected:
      status_code: 200
      assertions:
        - type: "contains"
          field: "body"
          value: "xmlns=\"http://www.w3.org/2000/svg\""
          message: "SVG应该包含正确的命名空间"
        - type: "contains"
          field: "body"
          value: "viewBox=\"0 0 64 64\""
          message: "SVG应该有正确的viewBox"
        - type: "regex"
          field: "body"
          value: "<svg[^>]*>.*</svg>"
          message: "SVG结构应该完整"
    timeout: "10s"
    retry: 2

  # ========== 缓存验证测试 ==========
  - name: "验证缓存头设置"
    description: "验证头像的缓存相关HTTP头设置"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/3"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Type: "cache-validation"
    expected:
      status_code: 200
      assertions:
        - type: "contains"
          field: "headers.cache-control"
          value: "public"
          message: "缓存控制应该设置为public"
        - type: "contains"
          field: "headers.cache-control"
          value: "max-age=86400"
          message: "缓存时间应该设置为1天"
        - type: "exists"
          field: "headers.last-modified"
          message: "应该包含Last-Modified头"
    timeout: "10s"
    retry: 2

  # ========== 错误处理测试 ==========
  - name: "测试不存在的头像ID(99)"
    description: "测试ID为99的头像，应该返回404错误"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/99"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Type: "invalid-id-high"
    expected:
      status_code: 404
      assertions:
        - type: "contains"
          field: "headers.content-type"
          value: "application/json"
          message: "错误响应应该是JSON格式"
        - type: "exists"
          field: "body.error_code"
          message: "错误响应应该包含error_code字段"
        - type: "contains"
          field: "body.error_details"
          value: "头像不存在"
          message: "错误详情应该说明头像不存在"
    timeout: "10s"
    retry: 2

  - name: "测试无效头像ID(0)"
    description: "测试ID为0的头像，应该返回404错误"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/0"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Type: "invalid-id-low"
    expected:
      status_code: 404
      assertions:
        - type: "contains"
          field: "headers.content-type"
          value: "application/json"
          message: "错误响应应该是JSON格式"
        - type: "exists"
          field: "body.error_code"
          message: "错误响应应该包含error_code字段"
    timeout: "10s"
    retry: 2

  - name: "测试非数字头像ID"
    description: "测试ID为abc的头像，应该返回404错误"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/abc"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Type: "non-numeric-id"
    expected:
      status_code: 404
      assertions:
        - type: "contains"
          field: "headers.content-type"
          value: "application/json"
          message: "错误响应应该是JSON格式"
        - type: "exists"
          field: "body.error_code"
          message: "错误响应应该包含error_code字段"
    timeout: "10s"
    retry: 2

  - name: "测试边界值头像ID(21)"
    description: "测试刚好超出范围的ID，应该返回404错误"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/21"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Type: "boundary-id"
    expected:
      status_code: 404
      assertions:
        - type: "contains"
          field: "headers.content-type"
          value: "application/json"
          message: "错误响应应该是JSON格式"
        - type: "exists"
          field: "body.error_code"
          message: "错误响应应该包含error_code字段"
    timeout: "10s"
    retry: 2

  # ========== 性能测试 ==========
  - name: "头像列表响应时间测试"
    description: "验证头像列表API的响应时间性能"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in"
      headers:
        Accept: "application/json"
        X-Request-ID: "${uuid}"
        X-Test-Type: "performance-list"
    expected:
      status_code: 200
      assertions:
        - type: "exists"
          field: "body.entries"
          message: "响应应该包含entries字段"
    timeout: "3s"
    retry: 1

  - name: "单个头像响应时间测试"
    description: "验证单个头像获取的响应时间性能"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/6"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Type: "performance-detail"
    expected:
      status_code: 200
      assertions:
        - type: "contains"
          field: "body"
          value: "<svg"
          message: "响应体应该包含SVG标签"
    timeout: "2s"
    retry: 1

  # ========== 综合验证测试 ==========
  - name: "验证所有头像可访问性"
    description: "快速验证所有10个头像都可以正常访问"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/4"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Type: "accessibility-check"
    expected:
      status_code: 200
      assertions:
        - type: "contains"
          field: "headers.content-type"
          value: "image/svg+xml"
          message: "Content-Type应该是image/svg+xml"
        - type: "contains"
          field: "body"
          value: "<svg"
          message: "响应体应该包含SVG标签"
    timeout: "10s"
    retry: 2

  - name: "验证错误响应格式一致性"
    description: "验证所有错误响应的格式是否一致"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/agent/avatar/built-in/invalid"
      headers:
        Accept: "image/svg+xml"
        X-Request-ID: "${uuid}"
        X-Test-Type: "error-format-consistency"
    expected:
      status_code: 404
      assertions:
        - type: "exists"
          field: "body.error_code"
          message: "错误响应应该包含error_code字段"
        - type: "exists"
          field: "body.description"
          message: "错误响应应该包含description字段"
        - type: "exists"
          field: "body.solution"
          message: "错误响应应该包含solution字段"
        - type: "exists"
          field: "body.error_link"
          message: "错误响应应该包含error_link字段"
        - type: "exists"
          field: "body.error_details"
          message: "错误响应应该包含error_details字段"
    timeout: "10s"
    retry: 2 