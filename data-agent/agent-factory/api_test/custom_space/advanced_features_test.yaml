name: "高级功能测试"
description: "专门测试动态变量、变量提取和链式测试等高级功能"

variables:
  base_url: "http://127.0.0.1:13020"
  api_prefix: "/api/agent-factory/v3"

variable_config:
  random_number_min: 100
  random_number_max: 999
  random_string_length: 6
  random_name_length: 8

tests:
  - name: "1. 动态变量创建空间"
    description: "使用各种动态变量创建空间"
    request:
      method: "POST"
      url: "{{base_url}}{{api_prefix}}/custom-space"
      headers:
        Accept: "application/json"
        Content-Type: "application/json"
        X-Request-ID: "${uuid}"
        X-Timestamp: "${timestamp}"
        X-Random-Token: "${random_string:12}"
      body:
        name: "高级功能测试-${random_string:6}"
        key: "advanced-test-${timestamp}"
        profile: "动态变量测试空间，创建者: ${random_name:8}，时间: ${timestamp_ms}，随机数: ${random_number:100-999}"
        members:
          - obj_type: "user"
            obj_id: "advanced-user-${random_number:1000-9999}"
          - obj_type: "dept"
            obj_id: "advanced-dept-${random_number:100-999}"
        resources:
          - resource_type: "data_agent"
            resource_id: "advanced-agent-${random_string:8}"
          - resource_type: "data_agent"
            resource_id: "secondary-agent-${random_string:8}"
        metadata:
          uuid: "${uuid}"
          timestamp: "${timestamp}"
          random_name: "${random_name:10}"
          random_number: "${random_number:100-999}"
          random_string: "${random_string:16}"
          test_data:
            session_id: "${uuid}"
            created_at: "${timestamp_ms}"
            version: "${random_number:1-10}"
    expected:
      status_code: 201
      assertions:
        - type: "exists"
          field: "body.id"
          message: "响应应该包含空间ID"
    variable_extraction:
      - name: "test_space_id"
        source: "body"
        path: "id"
    timeout: "15s"
    retry: 2

  - name: "2. 变量提取验证"
    description: "获取创建的空间详情并提取更多变量"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/custom-space/{{test_space_id}}"
      headers:
        Accept: "application/json"
        X-Request-ID: "${uuid}"
        X-Verify-Space: "{{test_space_id}}"
    expected:
      status_code: 200
      assertions:
        - type: "exists"
          field: "body.id"
          message: "空间ID应该存在"
        - type: "contains"
          field: "body.name"
          value: "高级功能测试"
          message: "空间名称应该包含'高级功能测试'"
        - type: "contains"
          field: "body.profile"
          value: "动态变量测试"
          message: "简介应该包含动态变量信息"
        - type: "exists"
          field: "body.created_at"
          message: "应该有创建时间"
    variable_extraction:
      - name: "space_name"
        source: "body"
        path: "name"
      - name: "space_key"
        source: "body"
        path: "key"
      - name: "space_profile"
        source: "body"
        path: "profile"
      - name: "created_at"
        source: "body"
        path: "created_at"
    timeout: "10s"
    retry: 2

  - name: "3. 链式测试 - 使用提取的变量"
    description: "使用前面提取的变量进行更新操作"
    request:
      method: "PUT"
      url: "{{base_url}}{{api_prefix}}/custom-space/{{test_space_id}}"
      headers:
        Accept: "application/json"
        Content-Type: "application/json"
        X-Request-ID: "${uuid}"
        X-Original-Name: "{{space_name}}"
        X-Update-Time: "${timestamp}"
      body:
        name: "{{space_name}} - 链式更新"
        profile: "原简介: {{space_profile}}，更新时间: ${timestamp_ms}，更新者: ${random_name:6}"
        metadata:
          original_name: "{{space_name}}"
          original_key: "{{space_key}}"
          original_created_at: "{{created_at}}"
          update_info:
            updated_by: "${random_name:8}"
            update_time: "${timestamp}"
            update_id: "${uuid}"
            random_data: "${random_string:20}"
    expected:
      status_code: 204
      assertions: []
    timeout: "10s"
    retry: 2

  - name: "4. 验证链式更新结果"
    description: "验证使用变量进行的更新是否成功"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/custom-space/{{test_space_id}}"
      headers:
        Accept: "application/json"
        X-Request-ID: "${uuid}"
        X-Final-Check: "true"
    expected:
      status_code: 200
      assertions:
        - type: "contains"
          field: "body.name"
          value: "链式更新"
          message: "空间名称应该包含'链式更新'"
        - type: "contains"
          field: "body.profile"
          value: "原简介"
          message: "简介应该包含原简介信息"
        - type: "contains"
          field: "body.profile"
          value: "更新时间"
          message: "简介应该包含更新时间信息"
    timeout: "10s"
    retry: 2

  - name: "5. 动态参数测试"
    description: "测试URL参数中的动态变量"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/custom-space"
      headers:
        Accept: "application/json"
        X-Request-ID: "${uuid}"
        X-Test-Type: "dynamic_params"
      params:
        page: "${random_number:1-3}"
        size: "${random_number:5-15}"
    expected:
      status_code: 200
      assertions:
        - type: "exists"
          field: "body.entries"
          message: "响应应该包含entries字段"
        - type: "exists"
          field: "body.total"
          message: "响应应该包含total字段"
    timeout: "10s"
    retry: 2

  - name: "6. 错误处理与动态变量"
    description: "在错误场景中使用动态变量"
    request:
      method: "POST"
      url: "{{base_url}}{{api_prefix}}/custom-space"
      headers:
        Accept: "application/json"
        Content-Type: "application/json"
        X-Request-ID: "${uuid}"
        X-Error-Test: "duplicate_key"
      body:
        name: "重复测试-${random_string:4}"
        key: "{{space_key}}"
        profile: "尝试使用重复key: {{space_key}}，时间: ${timestamp_ms}"
    expected:
      status_code: 400
      assertions:
        - type: "exists"
          field: "body.error_code"
          message: "应该返回错误代码"
        - type: "contains"
          field: "body.error_details"
          value: "已存在"
          message: "错误详情应该提示已存在"
          optional: true
    timeout: "10s"
    retry: 1

  - name: "7. 复杂动态数据创建"
    description: "创建包含复杂动态数据的空间"
    request:
      method: "POST"
      url: "{{base_url}}{{api_prefix}}/custom-space"
      headers:
        Accept: "application/json"
        Content-Type: "application/json"
        X-Request-ID: "${uuid}"
        X-Complex-Test: "true"
      body:
        name: "复杂动态空间-${random_name:4}"
        key: "complex-dynamic-${timestamp}"
        profile: "复杂动态数据测试，参考空间: {{space_name}}"
        members:
          - obj_type: "user"
            obj_id: "complex-user-${random_number:1000-9999}"
          - obj_type: "user"
            obj_id: "complex-admin-${random_number:1000-9999}"
          - obj_type: "dept"
            obj_id: "complex-dept-${random_number:100-999}"
        resources:
          - resource_type: "data_agent"
            resource_id: "complex-agent-${random_string:8}"
          - resource_type: "data_agent"
            resource_id: "backup-complex-agent-${random_string:8}"
        metadata:
          reference_space:
            id: "{{test_space_id}}"
            name: "{{space_name}}"
            key: "{{space_key}}"
          dynamic_data:
            creators:
              - name: "${random_name:6}"
                id: "${random_number:1000-9999}"
              - name: "${random_name:8}"
                id: "${random_number:1000-9999}"
            settings:
              max_users: "${random_number:50-200}"
              timeout: "${random_number:30-300}"
              features:
                - "feature_${random_string:4}"
                - "option_${random_string:6}"
            timestamps:
              created: "${timestamp_ms}"
              session: "${uuid}"
    expected:
      status_code: 201
      assertions:
        - type: "exists"
          field: "body.id"
          message: "响应应该包含空间ID"
    variable_extraction:
      - name: "complex_space_id"
        source: "body"
        path: "id"
    timeout: "15s"
    retry: 2

  - name: "8. 最终验证"
    description: "验证所有创建的空间都存在"
    request:
      method: "GET"
      url: "{{base_url}}{{api_prefix}}/custom-space/{{complex_space_id}}"
      headers:
        Accept: "application/json"
        X-Request-ID: "${uuid}"
        X-Final-Verification: "true"
    expected:
      status_code: 200
      assertions:
        - type: "exists"
          field: "body.id"
          message: "复杂空间应该存在"
        - type: "contains"
          field: "body.name"
          value: "复杂动态空间"
          message: "空间名称应该包含'复杂动态空间'"
        - type: "contains"
          field: "body.profile"
          value: "复杂动态数据测试"
          message: "简介应该包含复杂动态数据信息"
    timeout: "10s"
    retry: 2 